<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Content Manager</title>
    </head>
    <body>
        <!-- Include the script that builds the page and powers Netlify CMS -->
        <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>

        <script>

        CMS.registerEditorComponent({
            id: 'link_button',
            label: 'Button Link',
            // A bogus field so that the component doesn't look weird when rendered:
            fields: [
                { 
                    name: 'url',
                    label: 'URL', 
                    widget: 'string',
                    default: '/'
                },
                { 
                    name: 'text',
                    label: 'Text', 
                    widget: 'string',
                    default: 'View More'
                }
            ],
            // Never match anything so that the separator will be recognized as a horizontal rule when the document is reloaded:
            pattern: /<a href="(.*?)" class="btn">(.*?)<\/a>/ms,
            fromBlock(match) {
                return {
                    url: match[1],
                    text: match[2]
                };
            },
            toBlock(data) {
                return `<a href="${data.url}" class="btn">${data.text}</a>`;
            },
            toPreview(data) {
                return `<a href="${data.url}" class="btn">${data.text}</a>`;
            }
        });

        CMS.registerEditorComponent({
            id: 'separator',
            label: 'Horizontal Rule',
            // Never match anything so that the separator will be recognized as a horizontal rule when the document is reloaded:
            pattern: /.^/,
            toBlock(obj) {
                return '---';
            },
            toPreview(obj) {
                return '<hr>';
            }
        });

        async function getCounties() {
            let response = await fetch('/api/state_counties.json');
            let data = await response.json();
            return data;
        }
        getCounties().then((data) => { 
            registerCountyMap(data);
        });

        function registerCountyMap(data) {

            const countyOptions = Object.keys(data.county_paths).map((item) => {
                return {
                    // capitalize the first letter for the label
                    label: item.charAt(0).toUpperCase() + item.slice(1),
                    value: item
                }
            });
            
            CMS.registerEditorComponent({
                id: "countyMap",
                label: "County Map Block",
                fields: [
                    {
                        name: "highlighted_counties",
                        label: "Highlighted Counties",
                        widget: "list",
                        field: {
                            name: "county",
                            label: "County",
                            widget: "select",
                            options: countyOptions
                        }
                    }
                ],
                pattern: /{{ "(.*)" }}/,
                fromBlock: function(match) {
                    return {
                        attack: match[1]
                    };
                },
                toBlock: function(obj) {
                    if (!obj.highlighted_counties) return false;
                    let component = '';
                    component += `{ component('svgMap', {\n`;
                    component += `highlights: ${JSON.stringify(obj.highlighted_counties)},\n`;
                    component += `    width: 500,
    height: 600,
    style: {
        fillColor: '#dedede',
        highlightColor: '#007baf',
        strokeColor: 'white',
        strokeWidth: '1px',
        hoverColor: '#004071'
    }`;
                    component += `}) }`;
                    return component;
                },
                toPreview: function(obj) {
                    return ``;
                },
            });
        }
        </script>

        <!-- Netlify Identity Widget -->
        <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    </body>
</html>